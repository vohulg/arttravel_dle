// JavaScript Document
// TWS Gallery - by Al-x
// Version TWS Gallery 5.2
// Powered by http://wonderfullife.ru/
// Support by http://wonderfullife.ru/, http://inker.wonderfullife.ru/
//-----------------------------------------------------
// Copyright (c) 2007,2012 TWS
var jcarousel_id=0;function gallery_jcarousel(b,e,a,f,c,d){this.options={correction:5,num_move:e,mousewheel:a,fx:d,buffer_length:3,insert_length:0,selector:b,template:c};this.file={search_code:f.search_code,album_id:f.album_id};this.init=function(){if(!f.last||f.allnum<1){return}if(this.options.num_move<1){this.options.num_move=1}this.busy_state={remove:false,prev:false,next:false};this.move_on_answer=false;this.buffer_first=this.first=parseInt(f.first,10);this.buffer_last=this.last=parseInt(f.last,10);this.cursor=0;this.buffer={};this.buffer_all=parseInt(f.allnum,10)-1;this.options.insert_length=this.last-this.first+1;this.options.buffer_length*=this.options.insert_length;this.length=this.options.insert_length;f.start=parseInt(f.start,10);var g="";for(var j=this.first;j<=this.last;j++){this.buffer[j-this.first]=f.data[j];g+=this.buffer_item(j)}$("#"+this.options.selector).html(g);var h=this;this.car_pointer=$("#"+this.options.selector).carouFredSel({infinite:false,scroll:{items:this.options.num_move,fx:"none",mousewheel:this.options.mousewheel},auto:false,next:{button:"#"+this.options.selector+"next",conditions:function(){return h.jcarousel("next")}},prev:{button:"#"+this.options.selector+"prev",conditions:function(){return h.jcarousel("prev")}}});this.numvisible=$(this.car_pointer).triggerHandler("configuration","items.visible");if(this.options.insert_length-f.start<this.numvisible){f.start=this.options.insert_length-this.numvisible}$(this.car_pointer).trigger("slideTo",[f.start,0,null,null,null,"next"]);$(this.car_pointer).trigger("configuration",["scroll.fx",this.options.fx]);if(this.options.num_move>this.numvisible){this.options.num_move=this.numvisible}if(this.options.correction+this.options.num_move+this.numvisible>this.last){this.options.correction=this.last-this.options.num_move-this.numvisible}};this.jcarousel=function(g){var k,i,j;var h=this.options.num_move+this.options.correction;this.move_on_answer=false;switch(g){case"prev":if(this.busy_state.next){return false}i=this.get_cur_first();if(i-h<0){h=i}j=(i-this.options.num_move<this.first);if(i-h<this.first){request=this.buffer_get_prev();if(request===false){if(j){return false}}else{if(request){this.insert_prev(request,i)}else{if(j){this.move_on_answer=true;this.state_loading(true);return false}}}}if(i==this.first){return false}if(!this.busy_state.remove&&j){this.scroll_items(i-this.first,"prev");return false}break;case"next":if(this.busy_state.prev){return false}i=this.get_cur_last();if(i+h>this.buffer_all){h=this.buffer_all-i}j=(i+this.options.num_move>this.last);if(i+h>this.last){request=this.buffer_get_next();if(request===false){if(j){return false}}else{if(request){this.insert_next(request,i)}else{if(j){this.move_on_answer=true;this.state_loading(true);return false}}}}if(i==this.last){return false}if(!this.busy_state.remove&&j){this.scroll_items(this.last-i,"next");return false}break}return true};this.buffer_get=function(i,g){var h=this;$.get(dle_root+"engine/gallery/ajax/carousel.php",{search_code:this.file.search_code,search_i:i,album_id:this.file.album_id,skin:dle_skin},function(n){h.state_loading(false);h.file.search_code=n.search_code;if(n.error=="1"){DLEalert("Carousel Error! Please, report site administrator!",dle_info)}else{if(n.error=="2"){DLEalert(n.error_text,dle_info)}else{switch(g){case"prev":i=h.first;var m=parseInt(n.length,10);if(h.buffer_first-m<0){m=h.buffer_first}if(!n.data[i-1]){m=0}for(var l=0,j=h.cursor-1;l<m;l++,j--){if(j<0){j+=h.options.buffer_length}h.buffer[j]=n.data[--i]}h.buffer_first-=m;l=h.buffer_last-h.buffer_first-h.options.buffer_length+1;if(l>0&&m){h.buffer_last-=l}h.cursor-=m;if(h.cursor<0){h.cursor+=h.options.buffer_length}var k=parseInt(n.allnum,10)-1;if(h.buffer_all>k){l=h.buffer_all-k;if(l>m){l=m}h.buffer_all-=l}h.insert_prev(m,0);h.busy_state.prev=false;if(h.move_on_answer&&m){$(h.car_pointer).trigger("prev")}break;case"next":i=h.last;var k=parseInt(n.allnum,10)-1;if(h.buffer_all<k){h.buffer_all=k}var m=parseInt(n.length,10);if(m>h.buffer_all-h.buffer_last){m=h.buffer_all-h.buffer_last}if(m<0){m=0}for(var l=0,j=h.buffer_last-h.buffer_first+h.cursor+1;l<m;l++,j++){if(j>h.options.buffer_length-1){j-=h.options.buffer_length}h.buffer[j]=n.data[++i]}h.buffer_last+=m;l=h.buffer_last-h.buffer_first-h.options.buffer_length+1;if(l>0&&m){h.buffer_first+=l;h.cursor+=l;if(h.cursor>=h.options.buffer_length){h.cursor=h.options.buffer_length-h.cursor}}h.insert_next(m,0);h.busy_state.next=false;if(h.move_on_answer&&m){$(h.car_pointer).trigger("next")}break}}}},"json")};this.buffer_get_prev=function(){if(this.busy_state.next||this.busy_state.prev){return 0}if(this.first>this.buffer_first&&this.first<=this.buffer_last){if(this.first-this.options.insert_length>=this.buffer_first){return this.options.insert_length}else{if(this.first-this.options.num_move>=this.buffer_first){return this.buffer_last-this.first}else{if(this.first-this.options.num_move<0){return this.first}}}}var g=this.first-this.options.insert_length;if(g<0){g=0}this.buffer_get(g,"prev");this.busy_state.prev=true;return 0};this.buffer_get_next=function(){if(this.busy_state.next||this.busy_state.prev){return 0}if(this.last>=this.buffer_first&&this.last<this.buffer_last){if(this.last>=this.buffer_all){return false}else{if(this.last+this.options.insert_length<=this.buffer_last){return this.options.insert_length}else{if(this.last+this.options.num_move<=this.buffer_last){return this.buffer_last-this.last}else{if(this.last+this.options.num_move>this.buffer_all){return this.buffer_all-this.last}}}}}this.buffer_get(this.last+1,"next");this.busy_state.next=true;return 0};this.get_cur_first=function(){var g=$(this.car_pointer).triggerHandler("currentVisible");return parseInt(g[0].id.replace("i"+this.options.selector,""),10)};this.get_cur_last=function(){var g=$(this.car_pointer).triggerHandler("currentVisible");return parseInt(g[g.length-1].id.replace("i"+this.options.selector,""),10)};this.insert_next=function(g,h){if(g<1){return}if(!h){h=this.get_cur_last()}var k=this.numvisible+this.last-h-1;for(var j=0;j<g;j++,this.length++){$(this.car_pointer).trigger("insertItem",[this.buffer_item(++this.last),++k,false])}for(k++;this.length>this.options.insert_length*2;this.first++,this.length--){$(this.car_pointer).trigger("removeItem",[k,false])}};this.insert_prev=function(g,h){if(g<1){return}if(!h){h=this.get_cur_first()}var k=this.length-h+this.first;for(var j=0;j<g;j++,this.length++){$(this.car_pointer).trigger("insertItem",[this.buffer_item(--this.first),(k==this.length?"end":k),false])}for(;this.length>this.options.insert_length*2;this.last--,this.length--){$(this.car_pointer).trigger("removeItem",[--k,false])}};this.buffer_item=function(i){var h=this.options.template;var g=i-this.buffer_first+this.cursor;if(g>this.options.buffer_length-1){g-=this.options.buffer_length}if(this.file.search_code){this.buffer[g][1]=this.buffer[g][1].replace(/{sid}/gi,this.file.search_code)}h=h.replace(/{url}/gi,dle_root+(gallery_alt_url=="yes"?gallery_web_root:"index.php?do=gallery")+this.buffer[g][1]);h=h.replace(/{image}/gi,this.buffer[g][0].replace("{FOTO_URL}",gallery_image_url));h=h.replace(/{title}/gi,this.buffer[g][2]);h=h.replace(/{alt-title}/gi,this.buffer[g][3]?this.buffer[g][3]:this.buffer[g][2]);return'<li id="i'+this.options.selector+i+'">'+h+"</li>"};this.state_loading=function(g){var h=$("#"+this.options.selector+"loading");if(h){if(g){h.removeClass("loading").addClass("loading_show")}else{h.removeClass("loading_show").addClass("loading")}}};this.scroll_items=function(g,h){this.busy_state.remove=true;$(this.car_pointer).trigger("configuration",["scroll.items",g]);$(this.car_pointer).trigger(h);$(this.car_pointer).trigger("configuration",["scroll.items",this.options.num_move]);this.busy_state.remove=false};this.init()};